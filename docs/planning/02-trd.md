# TRD (기술 요구사항 정의서)

> 개발자/AI 코딩 파트너가 참조하는 기술 문서입니다.
> 기술 표현을 사용하되, "왜 이 선택인지"를 함께 설명합니다.

---

## MVP 캡슐

| # | 항목 | 내용 |
|---|------|------|
| 1 | 목표 | 설치 없이 브라우저에서 바로 즐기는 추억의 고전 테트리스 |
| 2 | 페르소나 | 전 연령 가족 단위 (점심시간/짧은 휴식 시간에 플레이) |
| 3 | 핵심 기능 | FEAT-1: 테트리스 기본 플레이 |
| 4 | 성공 지표 (노스스타) | 평균 세션 지속 시간 10분 이상 |
| 5 | 입력 지표 | 일일 활성 사용자(DAU), 스테이지 10 클리어 비율 |
| 6 | 비기능 요구 | 60fps 유지, 반응형(PC+모바일), 정확한 조작감 |
| 7 | Out-of-scope | 소셜 로그인, 리더보드 공유, 멀티플레이 |
| 8 | Top 리스크 | 조작감이 기대에 미치지 못함 |
| 9 | 완화/실험 | NES 테트리스 프레임 테이블 참조하여 정확한 속도 구현 |
| 10 | 다음 단계 | API 계약 정의 및 테스트 케이스 작성 |

---

## 1. 시스템 아키텍처

### 1.1 고수준 아키텍처

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     Client      │────▶│     Server      │────▶│    Database     │
│   (Phaser.js)   │     │   (FastAPI)     │     │    (SQLite)     │
│   웹 브라우저    │     │  하이스코어 API  │     │  점수 저장소     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │
        │  게임 로직 (클라이언트 사이드)
        │  - 테트로미노 생성/조작
        │  - 충돌 감지
        │  - 라인 클리어
        │  - 점수 계산
        │  - 레벨 시스템
        │  - 오디오 재생
        ▼
```

### 1.2 컴포넌트 설명

| 컴포넌트 | 역할 | 왜 이 선택? |
|----------|------|-------------|
| Frontend (Phaser.js) | 게임 렌더링, 입력 처리, 오디오 | 게임 전용 프레임워크로 Canvas 추상화, 사운드/입력 처리 내장 |
| Backend (FastAPI) | 하이스코어 CRUD API | Python 기반 경량 API, 자동 문서화, 빠른 개발 |
| Database (SQLite) | 점수 영구 저장 | 서버리스 친화, 설정 최소화, 충분한 성능 |

---

## 2. 권장 기술 스택

### 2.1 프론트엔드

| 항목 | 선택 | 이유 | 벤더 락인 리스크 |
|------|------|------|-----------------|
| 게임 엔진 | Phaser 3 | 2D 게임 최적화, 풍부한 문서, WebGL/Canvas 지원 | 낮음 |
| 언어 | TypeScript | 타입 안전성, IDE 지원, 버그 예방 | - |
| 번들러 | Vite | 빠른 HMR, Phaser와 호환 좋음 | 낮음 |
| 오디오 | Web Audio API (Phaser 내장) | 브라우저 네이티브, 지연 최소화 | 없음 |

### 2.2 백엔드

| 항목 | 선택 | 이유 | 벤더 락인 리스크 |
|------|------|------|-----------------|
| 프레임워크 | FastAPI | Python 기반, 자동 API 문서, 비동기 지원 | 낮음 |
| 언어 | Python 3.11+ | 가독성, 생산성, 라이브러리 풍부 | - |
| ORM | SQLAlchemy 2.0 | 표준 ORM, SQLite 지원 | 낮음 |
| 검증 | Pydantic v2 | FastAPI 통합, 타입 검증 | 낮음 |

### 2.3 데이터베이스

| 항목 | 선택 | 이유 |
|------|------|------|
| 메인 DB | SQLite | 서버리스 배포 친화, 하이스코어 저장에 충분 |
| 캐시 | 없음 (MVP) | 트래픽이 낮은 MVP에서는 불필요 |

### 2.4 인프라

| 항목 | 선택 | 이유 |
|------|------|------|
| 컨테이너 | Docker + Docker Compose | 로컬 개발 일관성 |
| 프론트엔드 호스팅 | Vercel / Netlify | 정적 사이트 무료 호스팅 |
| 백엔드 호스팅 | Railway / Render | Python 앱 무료 티어 |

---

## 3. 비기능 요구사항

### 3.1 성능

| 항목 | 요구사항 | 측정 방법 |
|------|----------|----------|
| 프레임률 | 60fps 유지 (PC/모바일) | 브라우저 devtools FPS 모니터 |
| 입력 지연 | < 16ms (1 프레임) | 키 입력 → 화면 반영 시간 |
| 초기 로딩 | < 3s (FCP) | Lighthouse |
| API 응답 | < 500ms (P95) | 하이스코어 저장/조회 |

### 3.2 보안

| 항목 | 요구사항 |
|------|----------|
| 인증 | 익명 UUID (localStorage) - MVP에서는 로그인 없음 |
| 점수 검증 | 서버 측 최소 검증 (점수 범위, 시간 간격) |
| HTTPS | 필수 |
| CORS | 허용 도메인 제한 |

### 3.3 확장성

| 항목 | 현재 | 목표 |
|------|------|------|
| 동시 사용자 | MVP: 100명 | v2: 1,000명 |
| 하이스코어 레코드 | MVP: 10,000건 | v2: 100,000건 |

---

## 4. 외부 API 연동

### 4.1 인증

| 서비스 | 용도 | 필수/선택 | 연동 방식 |
|--------|------|----------|----------|
| 없음 | MVP에서는 익명 플레이 | - | - |

### 4.2 기타 서비스

| 서비스 | 용도 | 필수/선택 | 비고 |
|--------|------|----------|------|
| 없음 (MVP) | - | - | v2에서 소셜 로그인 고려 |

---

## 5. 접근제어·권한 모델

### 5.1 역할 정의

| 역할 | 설명 | 권한 |
|------|------|------|
| Player | 게임 플레이어 | 게임 플레이, 본인 점수 저장/조회 |

### 5.2 권한 매트릭스

| 리소스 | Player |
|--------|--------|
| 게임 플레이 | O |
| 점수 저장 | O (본인) |
| 점수 조회 | O (전체 랭킹) |

---

## 6. 데이터 생명주기

### 6.1 원칙

- **최소 수집**: UUID와 점수만 수집, 개인정보 없음
- **익명성**: 사용자 식별 불가
- **보존 기한**: 무기한 (점수 기록)

### 6.2 데이터 흐름

```
게임 종료 → 점수 계산 → API 호출 → DB 저장 → 랭킹 조회
```

| 데이터 유형 | 보존 기간 | 삭제/익명화 |
|------------|----------|------------|
| 하이스코어 | 무기한 | 이미 익명 |
| 플레이어 UUID | 무기한 | localStorage에 저장 |

---

## 7. 테스트 전략 (Contract-First TDD)

### 7.1 개발 방식: Contract-First Development

본 프로젝트는 **계약 우선 개발(Contract-First Development)** 방식을 채택합니다.

```
┌─────────────────────────────────────────────────────────────┐
│                    Contract-First 흐름                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 계약 정의 (Phase 0)                                     │
│     ├─ API 계약: contracts/score.contract.ts               │
│     ├─ BE 스키마: backend/app/schemas/score.py             │
│     └─ 타입 동기화: TypeScript ↔ Pydantic                  │
│                                                             │
│  2. 테스트 선행 작성 (🔴 RED)                               │
│     ├─ BE 테스트: tests/api/test_score.py                  │
│     ├─ FE 테스트: src/__tests__/game/*.test.ts             │
│     └─ 모든 테스트가 실패하는 상태 (정상!)                  │
│                                                             │
│  3. Mock 생성 (FE 독립 개발용)                              │
│     └─ MSW 핸들러: src/mocks/handlers/score.ts             │
│                                                             │
│  4. 병렬 구현 (🔴→🟢)                                       │
│     ├─ BE: 테스트 통과 목표로 구현                          │
│     └─ FE: Mock API로 개발 → 나중에 실제 API 연결          │
│                                                             │
│  5. 통합 검증                                               │
│     └─ Mock 제거 → E2E 테스트                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 테스트 피라미드

| 레벨 | 도구 | 커버리지 목표 | 위치 |
|------|------|-------------|------|
| Unit | pytest / Vitest | ≥ 80% | tests/unit/, src/__tests__/ |
| Integration | pytest | Critical paths | tests/integration/ |
| E2E | Playwright | Key user flows | e2e/ |

### 7.3 테스트 도구

**백엔드:**
| 도구 | 용도 |
|------|------|
| pytest | 테스트 실행 |
| pytest-asyncio | 비동기 테스트 |
| httpx | API 클라이언트 |
| pytest-cov | 커버리지 측정 |

**프론트엔드:**
| 도구 | 용도 |
|------|------|
| Vitest | 테스트 실행 |
| MSW | API 모킹 |
| Playwright | E2E 테스트 |

### 7.4 계약 파일 구조

```
project/
├── contracts/                    # API 계약 (BE/FE 공유)
│   ├── types.ts                 # 공통 타입 정의
│   └── score.contract.ts        # 점수 API 계약
│
├── backend/
│   ├── app/
│   │   ├── schemas/             # Pydantic 스키마
│   │   │   └── score.py
│   │   ├── models/              # SQLAlchemy 모델
│   │   │   └── score.py
│   │   └── routes/              # API 라우트
│   │       └── score.py
│   └── tests/
│       └── api/
│           └── test_score.py
│
└── frontend/
    ├── src/
    │   ├── game/                # Phaser 게임 코드
    │   │   ├── scenes/
    │   │   ├── objects/
    │   │   └── config/
    │   ├── mocks/
    │   │   └── handlers/
    │   │       └── score.ts
    │   └── __tests__/
    │       └── game/
    └── e2e/
```

### 7.5 TDD 사이클

```
🔴 RED    → 실패하는 테스트 먼저 작성
🟢 GREEN  → 테스트를 통과하는 최소한의 코드 구현
🔵 REFACTOR → 테스트 통과 유지하며 코드 개선
```

### 7.6 품질 게이트

**병합 전 필수 통과:**
- [ ] 모든 단위 테스트 통과
- [ ] 커버리지 ≥ 80%
- [ ] 린트 통과 (ruff / ESLint)
- [ ] 타입 체크 통과 (mypy / tsc)

**검증 명령어:**
```bash
# 백엔드
pytest --cov=app --cov-report=term-missing
ruff check .
mypy app/

# 프론트엔드
npm run test -- --coverage
npm run lint
npm run type-check

# E2E
npx playwright test
```

---

## 8. API 설계 원칙

### 8.1 RESTful 규칙

| 메서드 | 용도 | 예시 |
|--------|------|------|
| GET | 조회 | GET /api/scores (랭킹 조회) |
| POST | 생성 | POST /api/scores (점수 저장) |

### 8.2 응답 형식

**성공 응답:**
```json
{
  "data": {
    "id": "uuid",
    "score": 12500,
    "level": 8,
    "lines": 45,
    "created_at": "2026-02-02T12:00:00Z"
  }
}
```

**에러 응답:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "점수는 0 이상이어야 합니다.",
    "details": [
      { "field": "score", "message": "must be >= 0" }
    ]
  }
}
```

### 8.3 API 버저닝

| 방식 | 예시 | 채택 여부 |
|------|------|----------|
| URL 경로 | /api/v1/scores | 권장 |

---

## 9. 게임 로직 상세

### 9.1 테트로미노 정의

```
I: ████     O: ██     T:  █      S:  ██     Z: ██
           ██       ███        ██         ██

L: █       J:   █
   █          █
   ██         ██
```

### 9.2 레벨별 낙하 속도 (NES 테트리스 참조)

| 레벨 | 프레임/드롭 | ms/드롭 (60fps) |
|------|------------|-----------------|
| 0 | 48 | 800 |
| 1 | 43 | 717 |
| 2 | 38 | 633 |
| 3 | 33 | 550 |
| 4 | 28 | 467 |
| 5 | 23 | 383 |
| 6 | 18 | 300 |
| 7 | 13 | 217 |
| 8 | 8 | 133 |
| 9 | 6 | 100 |
| 10+ | 5 | 83 |

### 9.3 점수 계산 (NES 스코어링)

| 라인 수 | 점수 (레벨 0) | 공식 |
|---------|--------------|------|
| 1 | 40 | 40 × (level + 1) |
| 2 | 100 | 100 × (level + 1) |
| 3 | 300 | 300 × (level + 1) |
| 4 (테트리스) | 1200 | 1200 × (level + 1) |

### 9.4 조작 키 매핑

| 동작 | PC | 모바일 |
|------|-----|--------|
| 좌 이동 | ← / A | 좌측 터치 |
| 우 이동 | → / D | 우측 터치 |
| 소프트 드롭 | ↓ / S | 하단 스와이프 |
| 하드 드롭 | Space | 상단 스와이프 |
| 시계방향 회전 | ↑ / W / X | 회전 버튼 |
| 반시계방향 회전 | Z | - |
| 일시정지 | P / ESC | 일시정지 버튼 |

---

## 10. 병렬 개발 지원 (Git Worktree)

### 10.1 Worktree 구조

```
~/projects/
├── tetris/                   # 메인 (main 브랜치)
├── tetris-game-core/         # Worktree: feature/game-core
├── tetris-game-ui/           # Worktree: feature/game-ui
├── tetris-score-api/         # Worktree: feature/score-api
└── tetris-audio/             # Worktree: feature/audio
```

### 10.2 병합 규칙

| 조건 | 병합 가능 |
|------|----------|
| 단위 테스트 통과 (🟢) | 필수 |
| 커버리지 ≥ 80% | 필수 |
| 린트/타입 체크 통과 | 필수 |

---

## Decision Log 참조

| ID | 항목 | 선택 | 근거 |
|----|------|------|------|
| D-05 | 게임 엔진 | Phaser.js | 2D 게임 최적화, 풍부한 생태계 |
| D-06 | 백엔드 | FastAPI | 경량, 자동 문서화 |
| D-07 | 데이터베이스 | SQLite | 서버리스 친화, MVP에 충분 |
| D-08 | 번들러 | Vite | 빠른 HMR, 모던 도구 |
